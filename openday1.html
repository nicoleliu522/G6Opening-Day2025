<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…­å¹´çº§å®¶é•¿å¼€æ”¾æ—¥é€‰è¯¾ç¨‹åºï¼ˆäº‘ç«¯ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">å…­å¹´çº§å®¶é•¿å¼€æ”¾æ—¥é€‰è¯¾ç¨‹åºï¼ˆäº‘ç«¯ç‰ˆï¼‰</h1>
      <p class="text-sm text-gray-600 mt-1">
        æŠ¥åä¿¡æ¯å®æ—¶å­˜å‚¨åœ¨ Firebase æ•°æ®åº“ï¼Œæ¯ç»„é™é¢ 8 äººï¼ˆå…­å¹´çº§1-3ç­ä¸4-5ç­å…±äº«åé¢ï¼‰ã€‚
      </p>
    </header>

    <form id="signupForm" class="bg-white rounded-lg shadow p-5 space-y-5">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label>
          <span class="text-sm font-medium">å­¦ç”Ÿå§“å</span>
          <input id="studentName" required class="mt-1 w-full border rounded p-1 border-gray-300 focus:ring-blue-500 focus:border-blue-500" />
        </label>
        <label>
          <span class="text-sm font-medium">ç­çº§</span>
          <select id="classNumber" required class="mt-1 w-full border rounded p-1">
            <option value="" disabled selected>é€‰æ‹©ç­çº§</option>
            <option value="1">å…­å¹´çº§1ç­</option>
            <option value="2">å…­å¹´çº§2ç­</option>
            <option value="3">å…­å¹´çº§3ç­</option>
            <option value="4">å…­å¹´çº§4ç­</option>
            <option value="5">å…­å¹´çº§5ç­</option>
          </select>
        </label>
        <fieldset>
          <legend class="text-sm font-medium">æ—¥æœŸ</legend>
          <div class="flex gap-3 mt-1">
            <label><input type="radio" name="day" value="english" required> 11æœˆ11æ—¥ï¼ˆè‹±è¯­ï¼‰</label>
            <label><input type="radio" name="day" value="math"> 11æœˆ14æ—¥ï¼ˆæ•°å­¦ï¼‰</label>
          </div>
        </fieldset>
      </div>

      <fieldset>
        <legend class="text-sm font-medium mt-3">åˆ†å±‚è¯¾ç¨‹ï¼ˆé™é¢ 8ï¼‰</legend>
        <div id="trackOptions" class="mt-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
          <p class="text-gray-500 text-sm col-span-full">è¯·é€‰æ‹©ç­çº§ä¸æ—¥æœŸä»¥æ˜¾ç¤ºè¯¾ç¨‹ã€‚</p>
        </div>
      </fieldset>

      <label class="flex items-center gap-2 text-sm">
        <input id="agree" type="checkbox" required class="text-blue-600" />
        æˆ‘å·²ç¡®è®¤æ‰€é€‰è¯¾ç¨‹ä¸å­©å­å®é™…åˆ†å±‚ä¸€è‡´ã€‚
      </label>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        æäº¤æŠ¥å
      </button>
    </form>

    <div id="message" class="hidden mt-4 p-4 rounded border text-sm"></div>

    <section id="preview" class="hidden mt-6 bg-white rounded-lg shadow p-5">
      <h2 class="text-lg font-semibold mb-3">å½“å¤©è¯¾ç¨‹é¢„è§ˆ</h2>
      <div id="previewList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyALbRZ6P-azQhY55YUbyC-Np6zewqb2WdY",
      authDomain: "opening-day-a4824.firebaseapp.com",
      databaseURL: "https://opening-day-a4824-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "opening-day-a4824",
      storageBucket: "opening-day-a4824.firebasestorage.app",
      messagingSenderId: "827603104559",
      appId: "1:827603104559:web:ad7e69bb5a67bf0d1f67da"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const signupsRef = db.ref("signups");

    // ğŸ“ å…­å¹´çº§è¯¾ç¨‹ä¿¡æ¯
    const COURSE = {
      english: {
        A: [
          { track: "ESL", teacher: "Ms. Chloe & Mr. Brian" },
          { track: "R/F.a", teacher: "Mr. Matthew & Ms. Kimberly" },
          { track: "R/F.b", teacher: "Mr. Henry & Ms. Kimberly" },
          { track: "H", teacher: "Ms. Arne" },
        ],
        B: [
          { track: "ESL", teacher: "Ms. Chloe & Mr. Brian" },
          { track: "R/F", teacher: "Mr. Matthew & Ms. Kimberly" },
          { track: "H", teacher: "Ms. Arne" },
        ],
      },
      math: {
        A: [
          { track: "S1", teacher: "æ¶‚æ‹æ‹" },
          { track: "S2", teacher: "åˆ˜å®" },
          { track: "H", teacher: "é­æ–‡è±" },
        ],
        B: [
          { track: "S", teacher: "æ¶‚æ‹æ‹" },
          { track: "H", teacher: "ç§¦è“‰è“‰" },
        ],
      },
    };

    // ğŸ“š å¦ä¸€èŠ‚å›ºå®šè¯¾ç¨‹
    const FIXED = {
      english: {
        "1": { period: "ç¬¬äºŒèŠ‚", subject: "ä¸­æ–‡ç§‘å­¦", teacher: "ç‹é‡‘è‰" },
        "2": { period: "ç¬¬äºŒèŠ‚", subject: "STEM", teacher: "Mr. James" },
        "3": { period: "ç¬¬äºŒèŠ‚", subject: "ä¸­æ–‡ç§‘å­¦", teacher: "æœé“ç‰›" },
        "4": { period: "ç¬¬ä¸€èŠ‚", subject: "General Sciences", teacher: "Mr. P" },
        "5": { period: "ç¬¬ä¸€èŠ‚", subject: "åœ°ç†", teacher: "å§šç‘¶" },
      },
      math: {
        "1": { period: "ç¬¬ä¸€èŠ‚", subject: "è¯­æ–‡", teacher: "é™ˆé’" },
        "2": { period: "ç¬¬ä¸€èŠ‚", subject: "General Sciences", teacher: "Mr. P" },
        "3": { period: "ç¬¬ä¸€èŠ‚", subject: "è¯­æ–‡", teacher: "å¸ˆåº†åº†" },
        "4": { period: "ç¬¬äºŒèŠ‚", subject: "è¯­æ–‡", teacher: "å¸ˆåº†åº†" },
        "5": { period: "ç¬¬äºŒèŠ‚", subject: "è¯­æ–‡", teacher: "é¡¾æ±Ÿæºª" },
      }
    };

    const form = document.getElementById("signupForm");
    const optionsEl = document.getElementById("trackOptions");
    const msgEl = document.getElementById("message");
    const previewEl = document.getElementById("preview");
    const previewList = document.getElementById("previewList");

    function getGroup(cn) {
      const n = Number(cn);
      if ([1,2,3].includes(n)) return "A";
      if ([4,5].includes(n)) return "B";
      return null;
    }

    let counts = {};
    signupsRef.on("value", snap => {
      const data = snap.val() || {};
      counts = {};
      Object.values(data).forEach(r => {
        const g = getGroup(r.classNumber);
        const key = `${r.day}_${g}_${r.track}`;
        counts[key] = (counts[key] || 0) + 1;
      });
      renderOptions();
    });

    function remaining(day, group, track) {
      const key = `${day}_${group}_${track}`;
      return 8 - (counts[key] || 0);
    }

    function renderOptions() {
      const cls = document.getElementById("classNumber").value;
      const day = form.day?.value;
      if (!cls || !day) return;
      const group = getGroup(cls);
      optionsEl.innerHTML = "";
      COURSE[day][group].forEach(c => {
        const remain = remaining(day, group, c.track);
        const disabled = remain <= 0 ? "disabled" : "";
        optionsEl.innerHTML += `
          <label class="flex justify-between items-center px-3 py-2 border rounded ${remain<=0?'opacity-50 bg-gray-100':''}">
            <div><input type="radio" name="track" value="${c.track}" ${disabled} required> ${c.track}ï¼ˆ${c.teacher}ï¼‰</div>
            <span class="text-xs ${remain>0?'text-emerald-700':'text-red-600'}">${remain>0?'å‰©ä½™ '+remain+'/8':'å·²æ»¡'}</span>
          </label>`;
      });
    }

    document.getElementById("classNumber").addEventListener("change", renderOptions);
    document.querySelectorAll('input[name="day"]').forEach(el => el.addEventListener("change", renderOptions));

    form.addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("studentName").value.trim();
      const cls = document.getElementById("classNumber").value;
      const day = form.day.value;
      const track = form.track.value;
      const group = getGroup(cls);
      const remain = remaining(day, group, track);

      if (remain <= 0) return alert("è¯¥è¯¾ç¨‹å·²æ»¡ï¼Œè¯·é€‰æ‹©å…¶å®ƒã€‚");

      const record = {
        studentName: name,
        classNumber: cls,
        day,
        track,
        timestamp: new Date().toISOString()
      };

      signupsRef.push(record)
        .then(() => {
          msgEl.className = "mt-4 p-4 rounded border border-green-300 bg-green-50 text-green-800";
          msgEl.textContent = "æŠ¥åæˆåŠŸï¼";
          msgEl.classList.remove("hidden");
          showPreview(cls, day, group, track);
          form.reset();
          renderOptions();
        })
        .catch(err => {
          msgEl.className = "mt-4 p-4 rounded border border-red-300 bg-red-50 text-red-800";
          msgEl.textContent = "æäº¤å¤±è´¥ï¼š" + err.message;
          msgEl.classList.remove("hidden");
        });
    });

    function showPreview(cls, day, group, track) {
      const chosen = COURSE[day][group].find(c => c.track === track);
      const remain = remaining(day, group, track);
      const fixed = FIXED[day][cls];
      previewList.innerHTML = `
        <div class="border rounded p-3 bg-gray-50">
          <div class="font-medium">${day==='english'?'ç¬¬ä¸€èŠ‚':'ç¬¬äºŒèŠ‚'} - ${chosen.track}ï¼ˆ${chosen.teacher}ï¼‰</div>
          <div class="text-sm text-gray-600 mt-1">${remain>0?'å‰©ä½™ '+remain+'/8':'å·²æ»¡'}</div>
        </div>
        <div class="border rounded p-3 bg-white">
          <div class="font-medium">${fixed.period} - ${fixed.subject}ï¼ˆ${fixed.teacher}ï¼‰</div>
        </div>`;
      previewEl.classList.remove("hidden");
    }
  </script>
</body>
</html>
