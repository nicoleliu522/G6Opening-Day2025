<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…­å¹´çº§å®¶é•¿å¼€æ”¾æ—¥é€‰è¯¾ç¨‹åº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind å¼€å‘ç‰ˆï¼ˆå¦‚éœ€ä¸­å›½å¤§é™†ç¨³å®šè®¿é—®ï¼Œå»ºè®®åæœŸæ”¹ä¸ºæœ¬åœ°æ„å»ºæˆ–æœ¬åœ°/æ ¡å†…CDNæ‰˜ç®¡ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* è½»é‡çº§åŸºç¡€æ ·å¼å…œåº•ï¼šè‹¥å¤–éƒ¨CDNæœªåŠ è½½ï¼Œä»ä¿è¯åŸºæœ¬å¯ç”¨ */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif; }
    input, select, textarea, button { font: inherit; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <main class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">å…­å¹´çº§å®¶é•¿å¼€æ”¾æ—¥é€‰è¯¾ç¨‹åº</h1>
      <p class="text-sm text-gray-600 mt-1">
        - å®¶é•¿ä»…å¯é€‰æ‹©å…¶ä¸­ä¸€å¤©å‚åŠ ï¼›æŠ¥åæ—¶éœ€é€‰æ‹©å­©å­çš„åˆ†å±‚ç­çº§ï¼›æŠ¥ååªå¯æäº¤ä¸€æ¬¡ã€‚
      </p>
    </header>

    <!-- è§†å›¾/é“¾æ¥ç”Ÿæˆï¼ˆä»…ç®¡ç†å‘˜è§†å›¾æ˜¾ç¤ºï¼‰ -->
    <section id="shareLinks" class="hidden bg-white rounded-lg shadow p-5 mb-6">
      <h2 class="text-lg font-semibold mb-2">é“¾æ¥ç”Ÿæˆä¸åˆ†äº«</h2>
      <p class="text-sm text-gray-600 mb-4">
        å·²æ ¹æ®å½“å‰éƒ¨ç½²è·¯å¾„ç”Ÿæˆä¸¤æ¡ HTTP é“¾æ¥ï¼šå®¶é•¿é€‰è¯¾ç¨‹åºä¸ç®¡ç†å‘˜å·¥å…·ã€‚å°†é¡µé¢éƒ¨ç½²åˆ°æ ¡å†…æœåŠ¡å™¨æˆ–å›½å†…äº‘å‚å•†ï¼ˆHTTP å¼€å¯ï¼‰åï¼Œè¿™ä¸¤æ¡é“¾æ¥æ— éœ€ VPN å³å¯è®¿é—®ã€‚
      </p>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å®¶é•¿é€‰è¯¾ç¨‹åºé“¾æ¥</label>
          <div class="flex gap-2">
            <input id="parentUrl" class="flex-1 rounded border border-gray-300 px-3 py-2 text-sm" readonly />
            <button id="copyParentUrl" class="px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">å¤åˆ¶</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†å‘˜å·¥å…·é“¾æ¥</label>
          <div class="flex gap-2">
            <input id="adminUrl" class="flex-1 rounded border border-gray-300 px-3 py-2 text-sm" readonly />
            <button id="copyAdminUrl" class="px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">å¤åˆ¶</button>
          </div>
        </div>
        <p class="text-xs text-gray-500">
          æç¤ºï¼šé“¾æ¥ä½¿ç”¨ http:// åè®®ç”Ÿæˆï¼›è¯·ç¡®ä¿æœåŠ¡å™¨æˆ–äº‘å­˜å‚¨å¼€å¯ HTTP è®¿é—®å¹¶æœªå¼ºåˆ¶è·³è½¬è‡³ HTTPSã€‚
        </p>
      </div>
    </section>

    <form id="signupForm" class="bg-white rounded-lg shadow p-5 space-y-5">
      <h2 class="text-lg font-semibold">æŠ¥åä¿¡æ¯</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label class="block md:col-span-1">
          <span class="block text-sm font-medium text-gray-700">å­¦ç”Ÿä¸­æ–‡åï¼ˆå¿…å¡«ï¼‰</span>
          <input type="text" name="studentNameCn" required class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500" placeholder="è¯·è¾“å…¥ä¸­æ–‡å" />
        </label>
      
        <label class="block md:col-span-1">
          <span class="block text-sm font-medium text-gray-700">å­¦ç”Ÿè‹±æ–‡åï¼ˆå¯é€‰ï¼‰</span>
          <input type="text" name="studentNameEn" class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500" placeholder="è¯·è¾“å…¥è‹±æ–‡å" />
        </label>
      
        <label class="block md:col-span-1">
          <span class="block text-sm font-medium text-gray-700">å®¶é•¿è”ç³»ç”µè¯</span>
          <input type="tel" name="phone" required class="mt-1 w-full rounded border-gray-300 focus:ring-blue-500" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
        </label>

        <label class="block md:col-span-1">
          <span class="block text-sm font-medium text-gray-700">æ‰€åœ¨ç­çº§</span>
          <select name="classNumber" id="classNumber" required
                  class="mt-1 w-full rounded border-gray-300 focus:border-blue-500 focus:ring-blue-500">
            <option value="" disabled selected>è¯·é€‰æ‹©å…­å¹´çº§ç­çº§</option>
            <option value="1">å…­å¹´çº§1ç­</option>
            <option value="2">å…­å¹´çº§2ç­</option>
            <option value="3">å…­å¹´çº§3ç­</option>
            <option value="4">å…­å¹´çº§4ç­</option>
            <option value="5">å…­å¹´çº§5ç­</option>
          </select>
        </label>

        <fieldset class="md:col-span-1">
          <legend class="block text-sm font-medium text-gray-700">å‚åŠ æ—¥æœŸï¼ˆä»…å¯é€‰å…¶ä¸€ï¼‰</legend>
          <div class="flex items-center gap-4 mt-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="day" value="english" class="text-blue-600 focus:ring-blue-500" required />
              <span>11æœˆ11æ—¥ï¼ˆè‹±è¯­ï¼‰</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="day" value="math" class="text-blue-600 focus:ring-blue-500" />
              <span>11æœˆ14æ—¥ï¼ˆæ•°å­¦ï¼‰</span>
            </label>
          </div>
        </fieldset>
      </div>

      <fieldset id="trackFieldset" class="space-y-2">
        <legend class="text-sm font-medium text-gray-700">åˆ†å±‚ç­çº§ï¼ˆæ¯ç­é™é¢ 8ï¼‰</legend>
        <p id="trackHint" class="text-sm text-gray-500">
          è¯·å…ˆé€‰æ‹©â€œæ‰€åœ¨ç­çº§â€å’Œâ€œå‚åŠ æ—¥æœŸâ€ï¼Œç³»ç»Ÿå°†å±•ç¤ºå¯é€‰åˆ†å±‚ç­çº§ã€ä»»è¯¾è€å¸ˆä¸å‰©ä½™åé¢ã€‚
        </p>
        <div id="trackOptions" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2"></div>
      </fieldset>

      <section id="schedulePreview" class="hidden bg-gray-50 border border-gray-200 rounded p-3 text-sm">
        <div class="font-medium mb-1">å½“æ—¥è¯¾èŠ‚å®‰æ’é¢„è§ˆ</div>
        <div id="scheduleLines" class="space-y-1"></div>
      </section>

      <label class="block">
        <span class="block text-sm font-medium text-gray-700">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</span>
        <textarea name="note" rows="3" class="mt-1 w-full rounded border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                  placeholder="å¦‚æœ‰ç‰¹æ®Šæƒ…å†µå¯åœ¨æ­¤è¯´æ˜"></textarea>
      </label>

      <div class="flex items-start gap-2">
        <input id="agree" type="checkbox" required class="mt-1 text-blue-600 focus:ring-blue-500" />
        <label for="agree" class="text-sm text-gray-700">
          æˆ‘å·²çŸ¥æ‚‰ï¼šå®¶é•¿åªèƒ½é€‰æ‹©å…¶ä¸­ä¸€å¤©å‚åŠ ï¼Œå¹¶ç¡®è®¤æ‰€é€‰åˆ†å±‚ç­çº§ä¸å­©å­å®é™…åˆ†å±‚ä¸€è‡´ã€‚
        </label>
      </div>

      <div class="flex gap-3">
        <button type="submit"
                class="inline-flex items-center justify-center px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
          æäº¤æŠ¥å
        </button>
        <button type="reset"
                class="inline-flex items-center justify-center px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">
          é‡ç½®
        </button>
      </div>
    </form>

    <section id="result" class="hidden mt-6 bg-green-50 border border-green-200 text-green-900 rounded-lg p-5">
      <h3 class="font-semibold mb-2">æŠ¥åæˆåŠŸ</h3>
      <div id="resultContent" class="text-sm space-y-1"></div>
      <p class="text-xs text-green-800 mt-3">æç¤ºï¼šè¯·æˆªå›¾ä¿å­˜ä¸Šè¿°ä¿¡æ¯ã€‚</p>
    </section>

    <!-- ç®¡ç†å‘˜å·¥å…·ï¼ˆä»…ç®¡ç†å‘˜è§†å›¾æ˜¾ç¤ºï¼‰ -->
    <section id="adminTools" class="hidden mt-10 bg-white rounded-lg shadow p-5">
      <details open>
        <summary class="cursor-pointer font-semibold">ç®¡ç†å‘˜å·¥å…·ï¼ˆå¯¼å‡ºæŠ¥å/ç»Ÿè®¡/æ¸…ç©ºï¼‰</summary>
        <div class="mt-4 space-y-4 text-sm">
          <div class="flex flex-wrap gap-2">
            <button id="exportCsvBtn" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">å¯¼å‡ºæŠ¥åä¿¡æ¯ï¼ˆCSVï¼‰</button>
            <button id="showStatsBtn" class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">æ›´æ–°å¹¶æŸ¥çœ‹åˆ†å±‚å‰©ä½™åé¢</button>
            <button id="clearAllBtn" class="px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700">æ¸…ç©ºæ‰€æœ‰æŠ¥åï¼ˆä¸å¯æ¢å¤ï¼‰</button>
          </div>
          <div id="statsPanel" class="hidden">
            <h4 class="font-medium mb-2">å½“å‰å‰©ä½™åé¢ï¼ˆæ¯ç­ä¸Šé™ 8ï¼‰</h4>
            <div id="statsTables" class="space-y-4"></div>
          </div>
          <p class="text-xs text-gray-500">
            è¯´æ˜ï¼šå½“å‰ç‰ˆæœ¬å°†æŠ¥åæ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚è‹¥éœ€å¤šäººåŒæ—¶æŠ¥åç»Ÿä¸€é™é¢ä¸é›†ä¸­å¯¼å‡ºï¼Œè¯·æ¥å…¥å›½å†…äº‘ï¼ˆé˜¿é‡Œäº‘OSS/è…¾è®¯äº‘COSï¼‰+ ç®€æ˜“åç«¯æˆ–è¡¨æ ¼æœåŠ¡ã€‚
          </p>
        </div>
      </details>
    </section>
  </main>

    <!-- Firebase SDK åˆå§‹åŒ– -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>

  <script>
    // ========== è§†å›¾ä¸é“¾æ¥ ==========
    const params = new URLSearchParams(location.search);
    const VIEW = params.get('view') || 'parent'; // 'parent' | 'admin'
    const shareLinksSection = document.getElementById('shareLinks');
    const adminToolsSection = document.getElementById('adminTools');

    function buildHttpLinks() {
      const host = location.host || 'your-domain.example';
      // ç¡®ä¿è·¯å¾„åŒ…å«æ–‡ä»¶åï¼ˆè‹¥éƒ¨ç½²ä¸º /index.htmlï¼Œå¯ä¿ç•™ï¼›è‹¥ä¸ºç›®å½•åˆ™ä»å¯è®¿é—®ï¼‰
      const path = location.pathname || '/index.html';
      const base = 'http://' + host + path;

      const parentUrl = base + (base.includes('?') ? '&' : '?') + 'view=parent';
      const adminUrl  = base + (base.includes('?') ? '&' : '?') + 'view=admin';

      const parentUrlEl = document.getElementById('parentUrl');
      const adminUrlEl = document.getElementById('adminUrl');
      if (parentUrlEl && adminUrlEl) {
        parentUrlEl.value = parentUrl;
        adminUrlEl.value = adminUrl;

        const copyParentBtn = document.getElementById('copyParentUrl');
        const copyAdminBtn = document.getElementById('copyAdminUrl');
        function copy(text) {
          navigator.clipboard?.writeText(text).then(() => {
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          }).catch(() => {
            // å…¼å®¹ä¸æ”¯æŒçš„ç¯å¢ƒ
            const ta = document.createElement('textarea');
            ta.value = text; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy');
            document.body.removeChild(ta);
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          });
        }
        copyParentBtn?.addEventListener('click', (e) => { e.preventDefault(); copy(parentUrl); });
        copyAdminBtn?.addEventListener('click', (e) => { e.preventDefault(); copy(adminUrl); });
      }
    }

    // æ ¹æ®è§†å›¾æ˜¾éšæ¨¡å—
    if (VIEW === 'admin') {
      shareLinksSection.classList.remove('hidden');
      adminToolsSection.classList.remove('hidden');
      buildHttpLinks();
    } else {
      // å®¶é•¿è§†å›¾éšè—ç®¡ç†å‘˜ç›¸å…³
      shareLinksSection.remove();
      adminToolsSection.remove();
    }

    // ========== å¸¸é‡ä¸é…ç½® ==========
    const MAX_PER_TRACK = 8;
    const STORAGE_KEY = 'openDaySignups'; // å…¨éƒ¨æŠ¥åè®°å½•æ•°ç»„
    const FORM_CACHE_KEY = 'openDaySignupCache'; // è¡¨å•ç¼“å­˜

    const DAY_LABEL = {
      english: '11æœˆ11æ—¥ï¼ˆè‹±è¯­ï¼Œä¸Šåˆï¼‰',
      math: '11æœˆ14æ—¥ï¼ˆæ•°å­¦ï¼Œä¸Šåˆï¼‰',
    };

    // åˆ†å±‚æ˜ å°„
    const TRACK_MAP = {
      english: {
        A: ['ESL', 'R/F.a', 'R/F.b', 'H'],
        B: ['ESL', 'R/F', 'H'],
      },
      math: {
        A: ['S1', 'S2', 'H'],
        B: ['S', 'H'],
      },
    };

    // ä»»æ•™è€å¸ˆæ˜ å°„
    const TEACHER_MAP = {
      english: {
        A: {
          'ESL': 'Ms. Chloe and Mr. Brian',
          'R/F.a': 'Mr. Matthew & Ms. Kimberly',
          'R/F.b': 'Mr. Henry & Ms. Kimberly',
          'H': 'Ms. Arne',
        },
        B: {
          'ESL': 'Ms. Chloe and Mr. Brian',
          'R/F': 'Mr. Matthew & Ms. Kimberly',
          'H': 'Ms. Arne',
        }
      },
      math: {
        A: {
          'S1': 'æ¶‚æ‹æ‹',
          'S2': 'åˆ˜å®',
          'H': 'é­æ–‡è±',
        },
        B: {
          'S': 'æ¶‚æ‹æ‹',
          'H': 'ç§¦è“‰è“‰',
        }
      }
    };

    // è¯¾èŠ‚å®‰æ’å‡½æ•°ï¼ˆåŒ…å«åˆ†å±‚ä»»è¯¾è€å¸ˆï¼‰
    function getSchedule(day, classNumber, track) {
      const n = Number(classNumber);
      const isA = [1,2,3].includes(n);
      const group = isA ? 'A' : 'B';
      const trackTeacher = (TEACHER_MAP[day] && TEACHER_MAP[day][group]) ? (TEACHER_MAP[day][group][track] || '') : '';

      function extraForEnglishDay(n) {
        if (n === 1) return 'ä¸­æ–‡ç§‘å­¦ï¼ˆç‹é‡‘è‰ï¼‰';
        if (n === 2) return 'STEMï¼ˆMr. Jamesï¼‰';
        if (n === 3) return 'ä¸­æ–‡ç§‘å­¦ï¼ˆæœé“ç‰›ï¼‰';
        if (n === 4) return 'General Sciencesï¼ˆMr. Pï¼‰';
        if (n === 5) return 'åœ°ç†ï¼ˆå§šç‘¶ï¼‰';
        return '';
      }
      function extraForMathDay(n) {
        if (n === 1) return 'è¯­æ–‡ï¼ˆé™ˆé’ï¼‰';
        if (n === 2) return 'General Sciencesï¼ˆMr. Pï¼‰';
        if (n === 3) return 'è¯­æ–‡ï¼ˆå¸ˆåº†åº†ï¼‰';
        if (n === 4) return 'è¯­æ–‡ï¼ˆå¸ˆåº†åº†ï¼‰';
        if (n === 5) return 'è¯­æ–‡ï¼ˆé¡¾æ±Ÿæºªï¼‰';
        return '';
      }

      if (day === 'english') {
        if (isA) {
          return {
            p1: `è‹±è¯­åˆ†å±‚è¯¾ï¼ˆ${track}ï¼Œæ•™å¸ˆï¼š${trackTeacher}ï¼‰`,
            p2: extraForEnglishDay(n),
            trackTeacher
          };
        }
        return {
          p1: extraForEnglishDay(n),
          p2: `è‹±è¯­åˆ†å±‚è¯¾ï¼ˆ${track}ï¼Œæ•™å¸ˆï¼š${trackTeacher}ï¼‰`,
          trackTeacher
        };
      } else if (day === 'math') {
        if (isA) {
          return {
            p1: extraForMathDay(n),
            p2: `æ•°å­¦åˆ†å±‚è¯¾ï¼ˆ${track}ï¼Œæ•™å¸ˆï¼š${trackTeacher}ï¼‰`,
            trackTeacher
          };
        }
        return {
          p1: `æ•°å­¦åˆ†å±‚è¯¾ï¼ˆ${track}ï¼Œæ•™å¸ˆï¼š${trackTeacher}ï¼‰`,
          p2: extraForMathDay(n),
          trackTeacher
        };
      }
      return { p1: '', p2: '', trackTeacher };
    }

    // DOM æŸ¥è¯¢
    const form = document.getElementById('signupForm');
    const classNumberEl = document.getElementById('classNumber');
    const trackOptionsEl = document.getElementById('trackOptions');
    const trackHintEl = document.getElementById('trackHint');
    const schedulePreview = document.getElementById('schedulePreview');
    const scheduleLines = document.getElementById('scheduleLines');
    const resultSection = document.getElementById('result');
    const resultContent = document.getElementById('resultContent');

    // ç®¡ç†å‘˜å·¥å…· DOMï¼ˆåœ¨ç®¡ç†å‘˜è§†å›¾ä¸‹æ‰å­˜åœ¨ï¼‰
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const showStatsBtn = document.getElementById('showStatsBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const statsPanel = document.getElementById('statsPanel');
    const statsTables = document.getElementById('statsTables');

    // å·¥å…·å‡½æ•°
    function getSelectedDay() {
      const day = form.querySelector('input[name="day"]:checked');
      return day ? day.value : null; // 'english' | 'math'
    }
    function getClassGroup() {
      const val = classNumberEl.value;
      if (!val) return null;
      const n = Number(val);
      if ([1,2,3].includes(n)) return 'A';
      if ([4,5].includes(n)) return 'B';
      return null;
    }
    function sanitizeId(str) {
      return str.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '-');
    }

    // æ•°æ®å­˜å–
    function loadSignups() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveSignups(list) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); } catch {}
    }

    function countFor(day, group, track) {
      const list = loadSignups();
      return list.filter(r => r.day === day && r.group === group && r.track === track).length;
    }
    
    function remainingFor(day, group, track) {
      return Math.max(0, MAX_PER_TRACK - countFor(day, group, track));
    }

    function clearTrackOptions() {
      trackOptionsEl.innerHTML = '';
      form.querySelectorAll('input[name="track"]').forEach(el => {
        el.required = false;
        el.disabled = true;
      });
    }

    function renderSchedulePreview() {
      const day = getSelectedDay();
      const cn = form.elements['classNumber'].value;
      const trackEl = form.querySelector('input[name="track"]:checked');
      const track = trackEl ? trackEl.value : null;
      if (!day || !cn || !track) {
        schedulePreview.classList.add('hidden');
        scheduleLines.innerHTML = '';
        return;
      }
      const s = getSchedule(day, Number(cn), track);
      scheduleLines.innerHTML = `
        <div>ç¬¬ä¸€èŠ‚ï¼š${s.p1}</div>
        <div>ç¬¬äºŒèŠ‚ï¼š${s.p2}</div>
      `;
      schedulePreview.classList.remove('hidden');
    }

    function renderTrackOptions() {
      const day = getSelectedDay();
      const group = getClassGroup();
      clearTrackOptions();
      schedulePreview.classList.add('hidden');
      scheduleLines.innerHTML = '';

      if (!day || !group) {
        trackHintEl.classList.remove('hidden');
        return;
      }

      const options = TRACK_MAP[day][group] || [];
      trackHintEl.classList.add('hidden');

      const frag = document.createDocumentFragment();
      options.forEach(opt => {
        const id = 'track-' + sanitizeId(day + '-' + group + '-' + opt);
        const wrapper = document.createElement('label');
        wrapper.className = 'flex items-center justify-between gap-3 rounded border border-gray-200 px-3 py-2 hover:bg-gray-50';

        const left = document.createElement('div');
        left.className = 'flex flex-col';

        const topRow = document.createElement('div');
        topRow.className = 'flex items-center gap-2';

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'track';
        input.value = opt;
        input.id = id;
        input.className = 'text-blue-600 focus:ring-blue-500';
        input.required = true;

        const span = document.createElement('span');
        span.textContent = opt;

        topRow.appendChild(input);
        topRow.appendChild(span);

        const teacherName = (TEACHER_MAP[day] && TEACHER_MAP[day][group]) ? (TEACHER_MAP[day][group][opt] || '') : '';
        const teacherLine = document.createElement('div');
        teacherLine.className = 'text-xs text-gray-500 pl-6';
        teacherLine.textContent = teacherName ? `æ•™å¸ˆï¼š${teacherName}` : '';

        left.appendChild(topRow);
        if (teacherName) left.appendChild(teacherLine);

        const classNumber = Number(form.elements["classNumber"].value);
        const remain = remainingFor(day, group, opt);
        const badge = document.createElement('span');
        badge.className = 'text-xs rounded px-2 py-0.5';
        if (remain > 0) {
          badge.textContent = `å‰©ä½™ ${remain}/${MAX_PER_TRACK}`;
          badge.classList.add('bg-emerald-50','text-emerald-700','border','border-emerald-200');
        } else {
          badge.textContent = 'å·²æ»¡';
          badge.classList.add('bg-red-50','text-red-700','border','border-red-200');
          input.disabled = true;
        }

        wrapper.appendChild(left);
        wrapper.appendChild(badge);
        frag.appendChild(wrapper);
      });

      trackOptionsEl.appendChild(frag);

      // é€‰æ‹©åˆ†å±‚åå±•ç¤ºè¯¾èŠ‚é¢„è§ˆ
      form.querySelectorAll('input[name="track"]').forEach(r => {
        r.addEventListener('change', renderSchedulePreview);
      });
    }

    // äº‹ä»¶ç»‘å®šï¼šæ—¥æœŸ/ç­çº§å˜åŒ–æ—¶æ›´æ–°åˆ†å±‚é€‰é¡¹
    form.querySelectorAll('input[name="day"]').forEach(r => r.addEventListener('change', renderTrackOptions));
    classNumberEl.addEventListener('change', renderTrackOptions);

    // æäº¤å¤„ç†
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!form.reportValidity()) return;
    
      const data = new FormData(form);
      const studentNameCn = (data.get('studentNameCn') || '').toString().trim();
      const studentNameEn = (data.get('studentNameEn') || '').toString().trim();
      const phone = (data.get('phone') || '').toString().trim();
      const classNumber = Number(data.get('classNumber'));
      const day = data.get('day'); // english / math
      const group = [1, 2, 3].includes(classNumber) ? 'A' : 'B';
      const track = data.get('track');
      const note = (data.get('note') || '').toString().trim();
    
      if (!studentNameCn || !phone || !classNumber || !day || !track) {
        alert('è¯·å®Œæ•´å¡«å†™å¿…å¡«é¡¹ï¼');
        return;
      }
    
      // å†æ¬¡æ£€æŸ¥å®¹é‡ï¼ˆé¿å…è¾¹ç•Œæ¡ä»¶ï¼‰
      if (remainingFor(day, group, track) <= 0) {
        alert('æŠ±æ­‰ï¼Œè¯¥åˆ†å±‚ç­çº§åé¢å·²æ»¡ï¼Œè¯·é€‰æ‹©å…¶ä»–åˆ†å±‚æˆ–æ›´æ¢æ—¥æœŸ/ç­çº§ç»„åˆã€‚');
        renderTrackOptions();
        return;
      }
    
      const s = getSchedule(day, classNumber, track);
      const record = {
        id:
          (window.crypto && crypto.randomUUID)
            ? crypto.randomUUID()
            : String(Date.now()) + Math.random().toString(16).slice(2),
        ts: new Date().toISOString(),
        studentNameCn,
        studentNameEn,
        phone,
        classNumber,
        day,
        dayLabel: DAY_LABEL[day],
        group,
        track,
        trackTeacher: s.trackTeacher || '',
        period1: s.p1,
        period2: s.p2,
        note,
      };
    
      const list = loadSignups();
      list.push(record);
      saveSignups(list);
    
      // æ˜¾ç¤ºç»“æœ
      resultContent.innerHTML = `
        <div><span class="font-medium">å­¦ç”Ÿå§“åï¼š</span>${studentNameCn}${studentNameEn ? ` (${studentNameEn})` : ''}</div>
        <div><span class="font-medium">è”ç³»ç”µè¯ï¼š</span>${phone}</div>
        <div><span class="font-medium">æ‰€åœ¨ç­çº§ï¼š</span>å…­å¹´çº§${classNumber}ç­</div>
        <div><span class="font-medium">å‚åŠ æ—¥æœŸï¼š</span>${DAY_LABEL[day]}</div>
        <div><span class="font-medium">åˆ†å±‚ç­çº§ï¼š</span>${track}</div>
        <div><span class="font-medium">åˆ†å±‚ä»»æ•™è€å¸ˆï¼š</span>${record.trackTeacher || '-'}</div>
        <div class="mt-2"><span class="font-medium">ç¬¬ä¸€èŠ‚ï¼š</span>${s.p1}</div>
        <div><span class="font-medium">ç¬¬äºŒèŠ‚ï¼š</span>${s.p2}</div>
        ${note ? `<div class="mt-2"><span class="font-medium">å¤‡æ³¨ï¼š</span>${note}</div>` : ''}
        <div class="text-xs text-gray-600 mt-2">æäº¤æ—¶é—´ï¼š${new Date(record.ts).toLocaleString()}</div>
      `;
      resultSection.classList.remove('hidden');

      // æ›¿æ¢æç¤ºéƒ¨åˆ†ï¼Œå¢åŠ æŒ‰é’®
      const tipContainer = document.createElement("div");
      tipContainer.className = "mt-3 flex items-center gap-2 text-xs text-green-800";
      const tipText = document.createElement("span");
      tipText.textContent = "å¦‚éœ€ä¿®æ”¹ï¼Œå¯ç‚¹å‡»é‡æ–°æŠ¥åï¼š";
      const redoBtn = document.createElement("button");
      redoBtn.textContent = "é‡æ–°æŠ¥å";
      redoBtn.className = "text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700";

      redoBtn.addEventListener("click", () => {
        if (confirm("ç¡®å®šè¦é‡æ–°æŠ¥åå—ï¼Ÿç°æœ‰æŠ¥åè®°å½•å°†ä»ç³»ç»Ÿåˆ é™¤ã€‚")) {
          // æŒ‰å§“ååŒ¹é…åˆ é™¤åˆšåˆšå†™å…¥çš„è®°å½•
          const nameToDelete = record.studentNameCn;
          signupsRef.orderByChild("studentNameCn").equalTo(nameToDelete).once("value", snap => {
            if (snap.exists()) {
              const updates = {};
              snap.forEach(child => {
                updates[child.key] = null; // åˆ é™¤èŠ‚ç‚¹
              });
              signupsRef.update(updates)
                .then(() => {
                  alert("âœ… å·²åˆ é™¤åŸæŠ¥åè®°å½•ï¼Œè¯·é‡æ–°å¡«å†™ã€‚");
                  location.reload(); // åˆ·æ–°é¡µé¢
                })
                .catch(err => alert("åˆ é™¤å¤±è´¥ï¼š" + err));
            } else {
              alert("æœªæ‰¾åˆ°æŠ¥åè®°å½•ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚");
            }
          });
        }
      });

      tipContainer.appendChild(tipText);
      tipContainer.appendChild(redoBtn);
      resultSection.appendChild(tipContainer);
    });

    // é‡ç½®
    form.addEventListener('reset', () => {
      setTimeout(() => {
        trackOptionsEl.innerHTML = '';
        trackHintEl.classList.remove('hidden');
        schedulePreview.classList.add('hidden');
        scheduleLines.innerHTML = '';
        resultSection.classList.add('hidden');
        try { localStorage.removeItem(FORM_CACHE_KEY); } catch {}
      }, 0);
    });

    // é¡µé¢åŠ è½½æ—¶æ¢å¤è¡¨å•ç¼“å­˜
    (function restoreFormCache() {
      try {
        const raw = localStorage.getItem(FORM_CACHE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.studentName) form.elements['studentName'].value = data.studentName;
        if (data.classNumber) classNumberEl.value = data.classNumber;
        if (data.day) {
          const dayEl = form.querySelector(`input[name="day"][value="${data.day}"]`);
          if (dayEl) dayEl.checked = true;
        }
        if (data.note) form.elements['note'].value = data.note;
        renderTrackOptions();
        if (data.track) {
          const id = 'track-' + sanitizeId(data.day + '-' + getClassGroup() + '-' + data.track);
          const trackEl = document.getElementById(id);
          if (trackEl && !trackEl.disabled) {
            trackEl.checked = true;
            renderSchedulePreview();
          }
        }
      } catch {}
    })();

    // ========== ç®¡ç†å‘˜å·¥å…·ï¼šå¯¼å‡º / ç»Ÿè®¡ / æ¸…ç©º ==========
    function toCsvValue(v) {
      const s = (v ?? '').toString();
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }
    function exportCsv() {
      const list = loadSignups();
      const header = [
        'æäº¤æ—¶é—´ISO','æäº¤æ—¶é—´æœ¬åœ°','å­¦ç”Ÿå§“å','ç­çº§','æ—¥æœŸ','æ—¥æœŸæ ‡ç­¾','åˆ†ç»„','åˆ†å±‚ç­çº§','åˆ†å±‚ä»»æ•™è€å¸ˆ','ç¬¬ä¸€èŠ‚','ç¬¬äºŒèŠ‚','å¤‡æ³¨'
      ];
      const rows = list.map(r => ([
        r.ts,
        new Date(r.ts).toLocaleString(),
        r.studentName,
        `å…­å¹´çº§${r.classNumber}ç­`,
        r.day,
        r.dayLabel,
        r.group,
        r.track,
        r.trackTeacher || '',
        r.period1,
        r.period2,
        r.note || ''
      ]));
      const csv = [header, ...rows].map(row => row.map(toCsvValue).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'å…­å¹´çº§å®¶é•¿å¼€æ”¾æ—¥æŠ¥å.csv';
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }
    exportCsvBtn?.addEventListener('click', (e) => { e.preventDefault(); exportCsv(); });

    function renderStats() {
      if (!statsTables) return;
      statsTables.innerHTML = '';

      function remainingFor(day, group, track) {
        return Math.max(0, MAX_PER_TRACK - countFor(day, group, track));
      }

      function makeTable(title, dayKey, groups) {
        const container = document.createElement('div');
        const h = document.createElement('div');
        h.className = 'font-medium';
        h.textContent = title;
        container.appendChild(h);

        const grid = document.createElement('div');
        grid.className = 'mt-2 grid sm:grid-cols-2 gap-3';

        groups.forEach(g => {
          const card = document.createElement('div');
          card.className = 'border rounded p-3';
          const head = document.createElement('div');
          head.className = 'font-semibold mb-2';
          head.textContent = `åˆ†ç»„ ${g}`;
          card.appendChild(head);

          const opts = TRACK_MAP[dayKey][g];
          opts.forEach(track => {
            const remain = remainingFor(dayKey, g, track);
            const line = document.createElement('div');
            line.className = 'flex justify-between text-sm py-1';
            const name = document.createElement('span');
            const t = (TEACHER_MAP[dayKey] && TEACHER_MAP[dayKey][g]) ? (TEACHER_MAP[dayKey][g][track] || '') : '';
            name.textContent = t ? `${track}ï¼ˆ${t}ï¼‰` : track;
            const val = document.createElement('span');
            val.textContent = `${remain}/${MAX_PER_TRACK}`;
            val.className = remain > 0 ? 'text-emerald-700' : 'text-red-700';
            line.appendChild(name);
            line.appendChild(val);
            card.appendChild(line);
          });

          grid.appendChild(card);
        });

        container.appendChild(grid);
        return container;
      }

      statsTables.appendChild(makeTable('11æœˆ11æ—¥ï¼ˆè‹±è¯­ï¼‰', 'english', ['A','B']));
      statsTables.appendChild(makeTable('11æœˆ14æ—¥ï¼ˆæ•°å­¦ï¼‰', 'math', ['A','B']));
      statsPanel.classList.remove('hidden');
    }
    showStatsBtn?.addEventListener('click', (e) => { e.preventDefault(); renderStats(); });

    clearAllBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      if (!confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æŠ¥åæ•°æ®ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
      try { localStorage.removeItem(STORAGE_KEY); } catch {}
      alert('å·²æ¸…ç©ºæ‰€æœ‰æŠ¥åæ•°æ®ã€‚');
      // åˆ·æ–°UI
      renderTrackOptions();
      if (!statsPanel.classList.contains('hidden')) renderStats();
    });

    /* ---------- Firebase é…ç½® BEGIN ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyALbRZ6P-azQhY55YUbyC-Np6zewqb2WdY",
      authDomain: "opening-day-a4824.firebaseapp.com",
      databaseURL: "https://opening-day-a4824-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "opening-day-a4824",
      storageBucket: "opening-day-a4824.firebasestorage.app",
      messagingSenderId: "827603104559",
      appId: "1:827603104559:web:ad7e69bb5a67bf0d1f67da"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const signupsRef = db.ref("signups");

    /* ---------- âœ… å®æ—¶æ ¹æ® Firebase æ›´æ–°å‰©ä½™åé¢ ---------- */
    let firebaseCounts = {}; // { english: { A: { ESL: 0, ... } }, math: { B: { S: 0, ... } } }
    
    // ç›‘å¬å®æ—¶æ•°æ®åº“å˜åŒ–
    signupsRef.on('value', snapshot => {
      const data = snapshot.val() || {};
      const counts = { english: { A: {}, B: {} }, math: { A: {}, B: {} } };
    
      Object.values(data).forEach(entry => {
        const day = entry.date === "2025-11-11" ? "english" : (entry.date === "2025-11-14" ? "math" : null);
        const group = entry.group;
        const track = entry.track;
        if (day && group && track) {
          counts[day][group][track] = (counts[day][group][track] || 0) + 1;
        }
      });
    
      firebaseCounts = counts;
      console.log("ğŸ”¥ Firebase æŠ¥åç»Ÿè®¡å·²æ›´æ–°", firebaseCounts);
    
      // è‹¥ç”¨æˆ·ç•Œé¢ä¸Šæ˜¾ç¤ºåˆ†å±‚é€‰é¡¹ï¼Œç›´æ¥é‡æ–°æ¸²æŸ“
      renderTrackOptions();
    });
    
    // æ›¿æ¢åŸ remainingFor å‡½æ•°
    function remainingFor(day, group, track) {
      const count = (firebaseCounts?.[day]?.[group]?.[track]) ?? 0;
      return Math.max(0, MAX_PER_TRACK - count);
    }
    
    function dayToDate(day){
      return day==="english" ? "2025-11-11" : day==="math" ? "2025-11-14" : "";
    }
    
    /* ---------- æäº¤è¡¨å•å†™å…¥ Firebase å‰é˜²é‡å¤ ---------- */
    form.addEventListener("submit", (e)=>{
      setTimeout(()=>{
        try{
          const list = loadSignups();
          if(!list?.length) return;
          const last = list.at(-1);
          if(last.firebaseSync) return;
    
          const cnName = last.studentNameCn?.trim();
          if(!cnName) return;
    
          // æ£€æŸ¥é‡å¤ï¼ˆä¸­æ–‡åç›¸åŒè§†ä¸ºé‡å¤ï¼‰
          signupsRef.orderByChild("studentNameCn").equalTo(cnName).once("value", snap=>{
            if(snap.exists()){
              alert("âš ï¸ æ­¤å­¦ç”Ÿå·²æŠ¥åè¿‡ï¼Œä¸èƒ½é‡å¤æäº¤ã€‚");
              return;
            }
            const payload = {
              studentNameCn: last.studentNameCn || "",
              studentNameEn: last.studentNameEn || "",
              phone: last.phone || "",
              classNumber: last.classNumber || "",
              group: last.group || "",
              track: last.track || "",
              trackTeacher: last.trackTeacher || "",
              period1: last.period1 || "",
              period2: last.period2 || "",
              note: last.note || "",
              date: dayToDate(last.day),
              timestamp: last.ts || new Date().toISOString()
            };
            signupsRef.push(payload).then(()=>{
              last.firebaseSync=true;
              saveSignups(list);
              console.log("âœ… å·²å†™å…¥ Firebase",payload);
            }).catch(err=>console.error(err));
          });
        }catch(err){
          console.error("Firebase åŒæ­¥é”™è¯¯",err);
        }
      },100);
    });
    
    /* ---------- ç®¡ç†å‘˜ç™»å½•æŒ‰é’® ---------- */
    const headerEl = document.querySelector("header");
    const adminBtn = document.createElement("button");
    adminBtn.textContent = "ç®¡ç†å‘˜ç™»å½•";
    adminBtn.className =
      "ml-auto mt-3 md:mt-0 bg-indigo-600 text-white text-sm px-3 py-1.5 rounded hover:bg-indigo-700";
    // è®© header å†…éƒ¨æˆä¸º flex å¸ƒå±€ï¼Œä¿è¯æ ‡é¢˜å’ŒæŒ‰é’®åœ¨ä¸€è¡Œï¼ˆå®½å±ï¼‰ï¼Œçª„å±è‡ªåŠ¨æ¢è¡Œ
    headerEl.classList.add("flex", "flex-wrap", "items-center", "gap-2");
    
    headerEl.appendChild(adminBtn);
    
    adminBtn.addEventListener("click", () => {
      const user = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜ç”¨æˆ·åï¼š");
      const pass = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š");
      if (user === "admin" && pass === "123") {
        showAdminTable();
      } else alert("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    });
    
    function showAdminTable() {
      signupsRef.once("value").then(snap => {
        const data = snap.val();
        if (!data) {
          alert("æš‚æ— æŠ¥åè®°å½•");
          return;
        }
        const entries = Object.entries(data); // [ [key, value], ... ]
    
        const wrap = document.createElement("div");
        wrap.className = "fixed inset-0 bg-black/40 flex items-center justify-center z-50";
    
        const box = document.createElement("div");
        box.className = "bg-white rounded p-4 shadow-lg max-h-[85vh] overflow-auto w-11/12 max-w-6xl";
    
        // é¡¶éƒ¨æŒ‰é’®åŒº
        const topBar = document.createElement("div");
        topBar.className = "mb-3 flex flex-wrap items-center justify-between gap-2";
        
        const leftTitle = document.createElement("h2");
        leftTitle.textContent = "æŠ¥åæ•°æ®ï¼ˆç‚¹å‡»åˆ é™¤åå®æ—¶æ›´æ–°ï¼‰";
        leftTitle.className = "text-lg font-semibold";
        topBar.appendChild(leftTitle);
    
        const btnGroup = document.createElement("div");
        btnGroup.className = "flex gap-2";
    
        const close = document.createElement("button");
        close.textContent = "å…³é—­";
        close.className = "bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600";
        close.onclick = () => wrap.remove();
    
        const clearAllBtn = document.createElement("button");
        clearAllBtn.textContent = "åˆ é™¤å…¨éƒ¨è®°å½•";
        clearAllBtn.className = "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700";
    
        clearAllBtn.addEventListener("click", () => {
          if (confirm("âš ï¸ ç¡®è®¤è¦åˆ é™¤æ‰€æœ‰æŠ¥åè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
            signupsRef
              .remove()
              .then(() => {
                alert("âœ… å·²æ¸…ç©ºæ‰€æœ‰è®°å½•ã€‚");
                wrap.remove();
              })
              .catch(err => alert("åˆ é™¤å¤±è´¥ï¼š" + err));
          }
        });
    
        btnGroup.appendChild(clearAllBtn);
        btnGroup.appendChild(close);
        topBar.appendChild(btnGroup);
        box.appendChild(topBar);
    
        // è¡¨æ ¼ä¸»ä½“
        const table = document.createElement("table");
        table.className = "min-w-full border text-sm";
        table.innerHTML = `
          <thead>
            <tr class='bg-gray-100'>
              <th class='border p-1'>ä¸­æ–‡å</th>
              <th class='border p-1'>è‹±æ–‡å</th>
              <th class='border p-1'>ç”µè¯</th>
              <th class='border p-1'>ç­çº§</th>
              <th class='border p-1'>æ—¥æœŸ</th>
              <th class='border p-1'>åˆ†ç»„</th>
              <th class='border p-1'>åˆ†å±‚</th>
              <th class='border p-1'>æ•™å¸ˆ</th>
              <th class='border p-1'>ç¬¬ä¸€èŠ‚</th>
              <th class='border p-1'>ç¬¬äºŒèŠ‚</th>
              <th class='border p-1'>å¤‡æ³¨</th>
              <th class='border p-1'>æ—¶é—´</th>
              <th class='border p-1 text-center'>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>`;
        const tbody = table.querySelector("tbody");
    
        entries.forEach(([key, r]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class='border p-1'>${r.studentNameCn || ""}</td>
            <td class='border p-1'>${r.studentNameEn || ""}</td>
            <td class='border p-1'>${r.phone || ""}</td>
            <td class='border p-1'>${r.classNumber || ""}</td>
            <td class='border p-1'>${r.date || ""}</td>
            <td class='border p-1'>${r.group || ""}</td>
            <td class='border p-1'>${r.track || ""}</td>
            <td class='border p-1'>${r.trackTeacher || ""}</td>
            <td class='border p-1'>${r.period1 || ""}</td>
            <td class='border p-1'>${r.period2 || ""}</td>
            <td class='border p-1'>${r.note || ""}</td>
            <td class='border p-1 whitespace-nowrap'>${new Date(r.timestamp).toLocaleString()}</td>
            <td class='border p-1 text-center'>
              <button class='delete-btn bg-red-500 text-white px-2 py-0.5 rounded hover:bg-red-600 text-xs'>åˆ é™¤</button>
            </td>`;
    
          // å•æ¡åˆ é™¤
          const delBtn = tr.querySelector(".delete-btn");
          delBtn.addEventListener("click", () => {
            if (confirm(`ç¡®è®¤åˆ é™¤ã€${r.studentNameCn || ""}ã€‘çš„æŠ¥åè®°å½•å—ï¼Ÿ`)) {
              signupsRef.child(key).remove()
                .then(() => {
                  alert("âœ… å·²åˆ é™¤è¯¥æ¡è®°å½•ã€‚");
                  tr.remove(); // ä»ç•Œé¢ç§»é™¤
                })
                .catch(err => alert("åˆ é™¤å¤±è´¥ï¼š" + err));
            }
          });
    
          tbody.appendChild(tr);
        });
    
        box.appendChild(table);
        wrap.appendChild(box);
        document.body.appendChild(wrap);
      });
    }
  </script>
</body>
</html>
